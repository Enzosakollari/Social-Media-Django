{% extends "core/base.html" %}

{% block title %}Chat with {{ other.username }}{% endblock %}

{% block content %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<div class="instagram-chat-container">
  {# LEFT: all users #}
  <div class="chat-sidebar">
    <h2 class="chat-sidebar-title">Messages</h2>

    <div class="online-users-section">
      <h3 class="chat-section-title">Users</h3>
      <div class="online-users-list">
        {% for user in all_users %}
          <a
            href="{% url 'chat' user.username %}"
            class="online-user-item {% if user.username == other.username %}active{% endif %}"
          >
            <div class="sidebar-avatar">
              {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}">
              {% else %}
                <div class="avatar-circle avatar-md">
                  {{ user.username|first|upper }}
                </div>
              {% endif %}
            </div>
            <div class="online-user-name">{{ user.username }}</div>
          </a>
        {% empty %}
          <p class="empty-muted">No other users.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  {# RIGHT: chat with selected user #}
  <section class="chat-wrapper">
    <header class="chat-header">
      <div class="chat-header-avatar">
        {% if other.profile.avatar %}
          <img src="{{ other.profile.avatar.url }}" alt="{{ other.username }}">
        {% else %}
          <div class="avatar-circle avatar-md">
            {{ other.username|first|upper }}
          </div>
        {% endif %}
      </div>
      <div class="chat-header-info">
        <h1>{{ other.username }}</h1>
        <p class="chat-subtitle">Messages are live in real time</p>
      </div>
    </header>

    <div id="messages" class="chat-box">
      {% for m in messages %}
        <div class="chat-message {% if m.sender == request.user %}mine{% else %}theirs{% endif %}">
          <div class="chat-bubble">
            <p class="chat-text">{{ m.text }}</p>
            <span class="chat-meta">
              {{ m.sender.username }} Â· {{ m.created_at|time:"H:i" }}
            </span>
          </div>
        </div>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input-row">
      <input
        id="message-input"
        type="text"
        placeholder="Type a message..."
        autocomplete="off"
        class="chat-input">

      <button type="submit" class="chat-send-btn" aria-label="Send">
        <svg viewBox="0 0 24 24" class="chat-send-icon">
          <path
            d="M5 19l14-7L5 5l3 6-3 6z"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>
    </form>
  </section>
</div>

<script>
  const currentUserId = {{ request.user.id }};
  const currentUsername = "{{ request.user.username }}";
  const otherUserId = {{ other.id }};
  const roomName = `chat_${Math.min(currentUserId, otherUserId)}_${Math.max(currentUserId, otherUserId)}`;

  const socket = io("http://localhost:8001", {
    transports: ["websocket"],
  });

  const messagesDiv = document.getElementById("messages");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("message-input");

  function appendMessage({ sender_username, text }) {
    const wrapper = document.createElement("div");
    wrapper.className =
      "chat-message" +
      (sender_username === currentUsername ? " mine" : " theirs");

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";

    const textP = document.createElement("p");
    textP.className = "chat-text";
    textP.textContent = text;

    const meta = document.createElement("span");
    meta.className = "chat-meta";
    meta.textContent = sender_username;

    bubble.appendChild(textP);
    bubble.appendChild(meta);
    wrapper.appendChild(bubble);
    messagesDiv.appendChild(wrapper);

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  socket.on("connect", () => {
    console.log("Connected:", socket.id);
    socket.emit("join_chat", {
      current_user_id: currentUserId,
      other_user_id: otherUserId,
    });
  });

  socket.on("new_chat_message", (data) => {
    if (data.room !== roomName) return;
    appendMessage({
      sender_username: data.sender_username,
      text: data.text,
    });
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    // 1) send via socket
    socket.emit("send_chat_message", {
      room: roomName,
      sender_username: currentUsername,
      text: text,
    });

    // 2) show instantly
    appendMessage({
      sender_username: currentUsername,
      text: text,
    });

    // 3) save in Django
    fetch("", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({ text }),
    });

    input.value = "";
  });

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
</script>
{% endblock %}
